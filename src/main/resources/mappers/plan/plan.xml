<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.triends.domain.plan.mapper.PlanMapper">

    <resultMap id="onlyPlan" type="planDto">
        <result property="planId" column="plan_id" />
        <result property="title" column="title" />
        <result property="startDate" column="start_date" />
        <result property="endDate" column="end_date" />
        <result property="centerLat" column="center_lat" />
        <result property="centerLng" column="center_lng" />
        <result property="thumbnail" column="thumbnail" />
    </resultMap>

    <resultMap id="wholePlan" type="planDto" extends="onlyPlan">
        <collection property="course" column="plan_id" javaType="list" ofType="wholeCourse" select="planCourseJoin" />
    </resultMap>

    <resultMap id="onlyCourse" type="courseDto">
        <result property="courseId" column="course_id" />
        <result property="planId" column="plan_id" />
        <result property="days" column="days" />
        <result property="startTime" column="start_time" />
        <result property="endTime" column="end_time" />
    </resultMap>

    <resultMap id="wholeCourse" type="courseDto" extends="onlyCourse">
        <association property="attractionDto" column="content_id" select="courseAttractionJoin" />
    </resultMap>

    <select id="planCourseJoin" resultMap="wholeCourse">
        select course_id, plan_id, days, start_time, end_time, content_id
        from course
        where plan_id=#{planId}
    </select>

    <select id="courseAttractionJoin" resultType="attractionDto">
        select content_id, content_type_id, title, addr1, addr2, zipcode, tel, first_image, readcount, sido_code, gugun_code, latitude, longitude, mlevel
        from attraction_info
        where content_id=#{contentId}
    </select>

    <select id="getMyPlanList" resultMap="onlyPlan" parameterType="int">
        select p.plan_id, p.title, p.start_date, p.end_date, p.center_lat, p.center_lng, p.thumbnail
        from plan p, members m
        where
            m.user_id=#{userId} and
            m.plan_id=p.plan_id
        order by p.plan_id desc
    </select>

    <select id="getPlanWithCourse" resultMap="wholePlan" parameterType="int">
        select plan_id, title, start_date, end_date, center_lat, center_lng, thumbnail
        from plan
        where plan_id=#{planId}
    </select>

    <delete id="delete" parameterType="int">
        delete from plan
        where plan_id=#{planId}
    </delete>

    <insert id="createPlan" parameterType="map" useGeneratedKeys="true" keyProperty="plan.planId">
        insert into plan (title, start_date, end_date, center_lat, center_lng, thumbnail)
        values (
                #{plan.title},
                #{plan.startDate},
                #{plan.endDate},
                <include refid="makeCenterLat" />,
                <include refid="makeCenterLng" />,
                <include refid="makeThumbnail" />
                )
    </insert>

    <sql id="makeCenterLat">
        (select avg(latitude) from attraction_info where content_id in
            <foreach collection="courses" item="course" index="index" open="(" close=")" separator=",">
                #{course.contentId}
            </foreach>
            )
    </sql>

    <sql id="makeCenterLng">
        (select avg(longitude) from attraction_info where content_id in
        <foreach collection="courses" item="course" index="index" open="(" close=")" separator=",">
            #{course.contentId}
        </foreach>
        )
    </sql>

    <sql id="makeThumbnail">
        (select first_image from attraction_info where content_id in
        <foreach collection="courses" item="course" index="index" open="(" close=")" separator=",">
            #{course.contentId}
        </foreach>
        and first_image is not null
        limit 1)
    </sql>

    <insert id="createCourses" parameterType="map">
        insert into course (plan_id, days, start_time, end_time, content_id)
        values
        <foreach collection="courses" item="course" separator=",">
            (#{plan.planId}, #{course.days}, #{course.startTime}, #{course.endTime}, #{course.contentId})
        </foreach>
    </insert>

    <insert id="acceptMember" parameterType="map">
        insert into members (plan_id, user_id)
        values (#{planId}, #{userId})
    </insert>
</mapper>